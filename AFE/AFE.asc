Version 4.1
SHEET 1 2832 1108
WIRE 1776 -496 1680 -496
WIRE 1952 -496 1840 -496
WIRE 1680 -368 1680 -496
WIRE 1776 -368 1680 -368
WIRE 1952 -368 1952 -496
WIRE 1952 -368 1856 -368
WIRE 1440 -208 1408 -208
WIRE 1536 -208 1504 -208
WIRE 1680 -208 1680 -368
WIRE 1680 -208 1616 -208
WIRE 1744 -208 1680 -208
WIRE -896 -176 -928 -176
WIRE -784 -176 -816 -176
WIRE -672 -176 -784 -176
WIRE 1952 -176 1952 -368
WIRE 1952 -176 1872 -176
WIRE 2000 -176 1952 -176
WIRE 2064 -176 2000 -176
WIRE 2208 -176 2144 -176
WIRE 352 -160 336 -160
WIRE 2208 -160 2208 -176
WIRE -784 -144 -784 -176
WIRE 1744 -144 1728 -144
WIRE -672 -128 -672 -176
WIRE 272 -112 272 -160
WIRE 272 -112 224 -112
WIRE 352 -112 352 -160
WIRE 384 -112 352 -112
WIRE 1824 -80 1824 -112
WIRE 272 -64 272 -112
WIRE 352 -64 352 -112
WIRE -784 -48 -784 -64
WIRE -672 -48 -672 -64
WIRE -672 -48 -784 -48
WIRE -784 -32 -784 -48
WIRE -1056 -16 -1056 -32
WIRE -304 -16 -432 -16
WIRE -160 -16 -304 -16
WIRE -48 -16 -160 -16
WIRE 48 -16 -48 -16
WIRE 160 -16 48 -16
WIRE 224 -16 224 -112
WIRE 224 -16 160 -16
WIRE -432 64 -432 -16
WIRE -304 64 -304 -16
WIRE -160 64 -160 -16
WIRE -48 64 -48 -16
WIRE 48 64 48 -16
WIRE 320 80 320 48
WIRE 224 112 224 -16
WIRE 240 112 224 112
WIRE 1184 128 1184 96
WIRE 384 144 384 -112
WIRE 384 144 368 144
WIRE 384 160 384 144
WIRE 432 160 384 160
WIRE 704 160 432 160
WIRE 832 160 784 160
WIRE 896 160 832 160
WIRE 1008 160 976 160
WIRE 1104 160 1008 160
WIRE 240 176 192 176
WIRE 1296 192 1232 192
WIRE 1408 192 1408 -208
WIRE 1408 192 1296 192
WIRE 1552 192 1408 192
WIRE 1808 192 1552 192
WIRE 1968 192 1888 192
WIRE -432 208 -432 128
WIRE -304 208 -304 144
WIRE -304 208 -432 208
WIRE -160 208 -160 144
WIRE -160 208 -304 208
WIRE -48 208 -48 128
WIRE -48 208 -160 208
WIRE 0 208 -48 208
WIRE 48 208 48 144
WIRE 48 208 0 208
WIRE 1968 208 1968 192
WIRE 832 224 832 160
WIRE 1008 224 1008 160
WIRE 1104 224 1072 224
WIRE 0 256 0 208
WIRE 320 272 320 208
WIRE 1008 304 1008 288
WIRE 832 352 832 288
WIRE 1072 352 1072 224
WIRE 1072 352 832 352
WIRE 1296 352 1296 192
WIRE 1296 352 1072 352
WIRE 2064 640 2000 640
WIRE 2320 640 2064 640
WIRE 2704 640 2320 640
WIRE 2064 688 2064 640
WIRE 2320 704 2320 640
WIRE 2704 704 2704 640
WIRE 2064 784 2064 768
WIRE 2320 784 2320 768
WIRE 2704 784 2704 768
WIRE 2064 944 2000 944
WIRE 2160 944 2064 944
WIRE 2320 944 2240 944
WIRE 2544 944 2320 944
WIRE 2704 944 2624 944
WIRE 2064 992 2064 944
WIRE 2320 1008 2320 944
WIRE 2704 1008 2704 944
WIRE 2064 1088 2064 1072
WIRE 2320 1088 2320 1072
WIRE 2704 1088 2704 1072
FLAG 320 272 0
FLAG -1056 -112 3V3
IOPIN -1056 -112 In
FLAG 320 48 3V3
IOPIN 320 48 In
FLAG -1056 -16 0
FLAG 432 160 out_TIA
IOPIN 432 160 Out
FLAG 0 256 0
FLAG 160 -16 Vin-
FLAG 1008 304 0
FLAG 1184 256 3V3
IOPIN 1184 256 In
FLAG 1184 96 0
FLAG 1552 192 DC_Input
FLAG 1824 -240 3V3
IOPIN 1824 -240 In
FLAG 1824 -80 0
FLAG -928 -176 3V3
IOPIN -928 -176 In
FLAG -784 -32 0
FLAG -784 -176 HPF_Vbias
IOPIN -784 -176 In
FLAG 1728 -144 HPF_Vbias
IOPIN 1728 -144 In
FLAG 2000 -176 AC_Input
FLAG 192 176 0
FLAG 1968 272 0
FLAG 2208 -96 0
FLAG 1920 640 3V3
IOPIN 1920 640 In
FLAG 2320 784 0
FLAG 2064 784 0
FLAG 2704 784 0
FLAG 1920 944 3V3
IOPIN 1920 944 In
FLAG 2320 1088 0
FLAG 2064 1088 0
FLAG 2704 1088 0
SYMBOL voltage -1056 -128 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V1
SYMATTR Value 3.3
SYMBOL current 48 64 R0
WINDOW 3 36 42 Left 2
WINDOW 123 24 28 Left 2
WINDOW 39 0 0 Left 0
WINDOW 0 -38 -32 Left 2
SYMATTR Value {DC}
SYMATTR InstName PhotoDiode_DC
SYMBOL res 368 -80 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R1
SYMATTR Value {R_FB}
SYMATTR SpiceLine tol=1
SYMBOL cap 336 -176 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C1
SYMATTR Value 1nF
SYMATTR SpiceLine Rser=50m
SYMBOL OPAx320-Q1 304 144 R0
WINDOW 0 0 -83 Bottom 2
WINDOW 3 2 -131 Top 2
SYMATTR InstName U1
SYMBOL current -304 64 R0
WINDOW 3 -179 88 Left 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
WINDOW 0 -65 -28 Left 2
SYMATTR Value SINE(0 2u 60)
SYMATTR InstName Noise
SYMBOL cap -64 64 R0
SYMATTR InstName Cj
SYMATTR Value 70p
SYMBOL current -160 64 R0
WINDOW 3 -138 103 Left 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
WINDOW 0 -95 -25 Left 2
SYMATTR Value SINE(0 {Pulse_max} 2)
SYMATTR InstName PhotoDiode_AC
SYMBOL OPAx320-Q1 1168 192 M180
WINDOW 0 -26 122 Bottom 2
WINDOW 3 -1 121 Top 2
SYMATTR InstName U4
SYMBOL res 992 144 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R5
SYMATTR Value 13k
SYMBOL cap 992 224 R0
SYMATTR InstName C5
SYMATTR Value 1µ
SYMBOL res 800 144 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R9
SYMATTR Value 13k
SYMBOL cap 816 224 R0
SYMATTR InstName C7
SYMATTR Value 1µ
SYMBOL OPAx320-Q1 1808 -176 R0
WINDOW 0 53 -65 Bottom 2
WINDOW 3 126 -120 Top 2
SYMATTR InstName U2
SYMBOL cap 1504 -224 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C3
SYMATTR Value 10µ
SYMBOL res 1632 -224 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R4
SYMATTR Value 82k
SYMBOL res 1872 -384 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName Rfb
SYMATTR Value 510k
SYMBOL res -800 -192 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R7
SYMATTR Value 3Meg
SYMBOL res -800 -160 R0
SYMATTR InstName R8
SYMATTR Value 3Meg
SYMBOL cap -688 -128 R0
SYMATTR InstName C2
SYMATTR Value 1µ
SYMBOL cap 1840 -512 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C6
SYMATTR Value 27n
SYMATTR SpiceLine Rser=50m
SYMBOL cap 2192 -160 R0
SYMATTR InstName C4
SYMATTR Value 5p
SYMBOL cap 1952 208 R0
SYMATTR InstName C8
SYMATTR Value 5p
SYMBOL res 2048 672 R0
SYMATTR InstName R6
SYMATTR Value 100k
SYMBOL res 2016 624 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R10
SYMATTR Value 100k
SYMBOL cap 2304 704 R0
SYMATTR InstName C9
SYMATTR Value 1n
SYMBOL cap 2688 704 R0
SYMATTR InstName C10
SYMATTR Value 5p
SYMBOL res 2048 976 R0
SYMATTR InstName R13
SYMATTR Value 100k
SYMBOL res 2016 928 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R14
SYMATTR Value 100k
SYMBOL res 2256 928 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R15
SYMATTR Value 0.1k
SYMBOL cap 2304 1008 R0
SYMATTR InstName C11
SYMATTR Value 1n
SYMBOL res 2640 928 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R16
SYMATTR Value 1k
SYMBOL cap 2688 1008 R0
SYMATTR InstName C12
SYMATTR Value 5p
TEXT -376 -504 Left 2 !.tran 0 10m 0 1us startup
TEXT -376 -376 Left 2 !.param R_FB=100k
TEXT -728 280 Left 2 ;- Typ. Ira = 55uA, but according to sr calc, signal is 1uA - 5uA \nwith red's 1mW/cm2. Will take Ipd_max = 60uA for cushion\n  > Did quick short ckt Exp & good Ipd_max is 30uA\n- Selecting R_FB: 3.2V-0.1V/30uA ~ 100k\n- Typ. rise & fall time = 100ns\n- Will use diode Cap at Vr = Vbias ~0V -> 70pF. B/c diode\nisn't reverse biased (In- = In+) voltage isn't a factor for Ipd
TEXT -8 320 Left 2 ;No need to bias IN+. Amp will saturate but\nOverload Revovery Time is ~100ns!
TEXT -368 -344 Left 2 !.param DC=15u
TEXT -376 -312 Left 2 !.param Pulse_min=DC/500
TEXT -376 -440 Left 2 ;.ac dec 100 .1 10Meg
TEXT -376 -536 Left 2 ;.dc PhotoDiode_DC 0 40u 0.5u
TEXT 888 416 Left 2 ;Want Fc around 10Hz b/c 5Hz is max pulse freq\nUse Sallen Key with equal values- Fc ~ 7.7Hz\n5Hz is attenuated by ~15%... Need to have SW to counteract
TEXT 1520 -688 Left 2 ;HPF Fc = 0.2 since min pulse freq = 0.5Hz\nLPF Fc = 11.5Hz\nInverting BPF fine because only care for Pk-Pk\nGain of 510/82 ~ 6.2 and DC offset = 1.6
TEXT -376 -280 Left 2 !.param Pulse_max=DC/5
TEXT -56 -288 Left 2 ;Perfusion Index: 0.2% - 20%
TEXT -960 -376 Left 2 ;OPA320 input bias current max of 50pA so \ninput R = 0.1V/50pA = 2Gohm
TEXT -1576 -88 Left 2 ;V+ pins of Amps should have 0.1uF cap
TEXT -1376 296 Left 2 ;Resistor Tolerances: 1%\nTIA Feedback Cap & Active filter Caps: C0G\nAll other caps: X7R
TEXT 1640 336 Left 2 ;Don't need LPF to get DC signal b/c can implement LPF/Averaging in SW. \nActive filter also serves as a buffer between TIA output & ADC
TEXT 424 -144 Left 2 ;BW ~ 1500Hz, don't need fast response \nsince signals of interest are < 10Hz\n \n100k Rfb gives max Ipd of 31uA
TEXT -376 -472 Left 2 ;.fra tstart=0 dtmax=1u
TEXT 1672 24 Left 2 ;SAR ADC samples for ~100ns.\nTyp values from STM32WB55 datasheet
TEXT 2120 552 Left 2 ;Battery ADC input circuit\nRser = 1k, Cshu = 1nF
TEXT 552 624 Left 2 ;Design Choices\n- I could move AC coupling cap to beginning of LPF & make band pass\nbut I need gain & SallenKey architecture doesn't play well with too \nmuch gain. For now, will take cost of additional amp but may need \nmore elegant active filter arch for future
